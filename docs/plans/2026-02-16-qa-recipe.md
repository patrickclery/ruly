# WorkAxle QA Acceptance Testing Recipe — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a `qa` recipe that accepts acceptance criteria (from Jira tickets or PR descriptions), uses the existing `automation-test-qa` repo's Playwright infrastructure to write and run tests against dev.workaxle.com.

**Architecture:** The agent works directly in the `automation-test-qa` repo clone. It reads existing page objects and test specs to understand patterns, writes new spec files using the repo's existing fixtures/page objects/API helpers, and runs them with `npx playwright test`. A single rule file teaches the agent the repo layout and workflow. Two skills handle the key actions: `run-acceptance-test` (AC → spec → run) and `sync-qa-repo` (pull latest + report changes). No selector duplication — the source `.ts` files ARE the source of truth.

**Tech Stack:** Existing `automation-test-qa` Playwright + TypeScript infrastructure, Ruly recipe (YAML), Ruly rules (Markdown), `gh` CLI, Jira CLI.

---

## Context: PR 7495 — Manager-to-Manager Delegation

First feature to validate. AC from the PR:

- Delegation to another manager succeeds when both gates enabled
- Delegation to a plain employee is rejected when both gates enabled
- Original behavior preserved when either gate is disabled
- Cross-location delegation works between managers

## Context: automation-test-qa Repo

| Layer            | Key Files                                                                       | Purpose                                                                                               |
|------------------|---------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| **Config**       | `playwright.config.ts`                                                          | 60s timeout, 1 worker, 500ms slowMo, `America/Toronto` tz, 1536x864, headless, auth via setup project |
| **Auth**         | `tests/auth.setup.ts`                                                           | Runs once: login → save state to `playwright/.auth/user.json` → all tests reuse it                    |
| **Fixture**      | `utils/fixtures/base-fixture.ts`                                                | Custom `test` with `pageManager` + `api` fixtures — **import this in all new specs**                  |
| **Base Page**    | `pages/basePage.ts`                                                             | Helpers: `stableClick`, `fillReactSelectInput`, `selectDate`, `searchByName`, `autoConfirmIfPresent`  |
| **Page Manager** | `pages/pageManager.ts`                                                          | Facade: `signinPage`, `navigationPage`, `schedulePage`, `peoplePage`, `timecardsPage`, etc.           |
| **Page Objects** | `pages/{signInPage,managementPage,settingsPage,navigationPage}/`                | Selectors and interaction methods per UI area                                                         |
| **API Helpers**  | `api/helpers/{employee,schedule,timesheet,location,timeOff,workCycle}Helper.ts` | CRUD for test data setup/teardown                                                                     |
| **Test Data**    | `test-data/users.json`                                                          | `demo@workaxle.com` / `workaxle` + roles/locations                                                    |
| **Environment**  | `utils/environment-util.ts`                                                     | `CLIENT_ENV_CLUSTER` secret pattern, resolves baseUrl/apiBaseUrl/auth0                                |
| **Specs**        | `tests/management/`, `tests/settings/`                                          | Existing specs organized by feature area                                                              |

## Context: How Their Tests Work

```typescript
// Every spec follows this pattern:
import { expect, test } from '@fixtures/base-fixture';

test.describe('Feature Name', () => {
  test.beforeEach(async ({ pageManager, api }) => {
    // API setup: create test data
    // Navigate to the page
  });

  test.afterEach(async ({ api }) => {
    // API cleanup: delete test data
  });

  test('criterion description', async ({ pageManager }) => {
    await test.step('Step 1: do something', async () => {
      // Use pageManager.schedulePage, pageManager.peoplePage, etc.
    });
    await test.step('Step 2: assert outcome', async () => {
      // expect(...).toBe(...)
    });
  });
});
```

Tests run via: `npx playwright test tests/path/to/spec.ts`

Auth runs automatically as a dependency (the `chromium` project depends on the `setup` project in playwright.config.ts).

---

## Task 1: Clone automation-test-qa and Install Dependencies

**Files:**
- Clone to: `/Users/patrick/agents/qa/`

**Step 1: Clone the repo**

```bash
cd /Users/patrick/agents
gh repo clone workaxle/automation-test-qa qa
```

**Step 2: Install dependencies**

```bash
cd /Users/patrick/agents/qa
npm install
npx playwright install chromium
```

**Step 3: Set up environment**

Create a `.env` file with the dev environment secrets. Check if there's a `.env.example` or the README's `CLIENT_ENV_CLUSTER` pattern:

```bash
# The env var name follows: {CLIENT}_{ENV}_{CLUSTER}
# For dev, it should be WORKAXLE_DEV_US or similar
# Check existing patterns:
cat /Users/patrick/agents/qa/.env.example 2>/dev/null || true
```

If no `.env` exists, create one based on the README pattern with dev credentials.

**Step 4: Verify the setup runs**

```bash
cd /Users/patrick/agents/qa
npx playwright test --project=setup
```

Expected: Auth setup passes, `playwright/.auth/user.json` is created.

No commit needed — local setup.

---

## Task 2: Create the QA Testing Rule

**Files:**
- Create: `rules/workaxle/qa/qa-testing.md`

This single rule file teaches the agent the repo layout, how to read existing page objects, how to write new specs, and how to run them.

**Step 1: Create the rule**

Write to `rules/workaxle/qa/qa-testing.md`:

```markdown
---
description: QA acceptance testing using the automation-test-qa Playwright infrastructure
alwaysApply: false
requires:
  - ../orchestrator/playwright.md
---

# QA Acceptance Testing

## Repo Location

All QA test work happens in `/Users/patrick/agents/qa/`.

This is a Playwright + TypeScript project maintained by the QA team. It has page objects, API helpers, test data, and existing specs. **Use what's already there — do not recreate infrastructure.**

## Repo Layout

```
automation-test-qa/
  playwright.config.ts          # Config (60s timeout, 1 worker, setup→chromium projects)
  tests/
    auth.setup.ts               # Login bootstrap — runs automatically before all tests
    management/                 # Specs by feature area
      schedule/                 # 8 specs: shifts, copy/paste, segments, views, filters
      timecard/
      weekly-timesheets/
      people/                   # Export, work cycle assignment
      employee-restrictions/
    settings/                   # Locations, shift templates, time bank, work cycles
  pages/                        # Page Object Model
    basePage.ts                 # Base class: stableClick, fillReactSelectInput, selectDate, searchByName, autoConfirmIfPresent, downloadByClick
    pageManager.ts              # Facade: all page objects in one place
    signInPage/                 # Login page
    navigationPage/             # Sidebar navigation
    managementPage/             # Schedule, timecards, people, employee restrictions, weekly timesheets
    settingsPage/               # Locations, shift templates, time bank, work cycles
  api/
    apiSignIn.ts                # Auth0 OAuth + GraphQL signIn
    helpers/                    # CRUD: employee, schedule, timesheet, location, timeOff, workCycle
  utils/
    fixtures/base-fixture.ts    # Custom test fixture with pageManager + api
    environment-util.ts         # Environment/secrets resolver
  test-data/
    users.json                  # Test users (demo@workaxle.com / workaxle)
```

## Before Writing Any Test

1. **Read existing page objects** to find selectors you need:
   - Read `pages/pageManager.ts` to see all available page objects
   - Read the specific page object file (e.g., `pages/managementPage/peoplePage/`) for selectors
   - Read `pages/basePage.ts` for helper methods

2. **Read a similar existing spec** to match the pattern:
   - Browse `tests/` for a spec that tests a similar feature area
   - Match its imports, describe/beforeEach/afterEach/step structure

3. **Check API helpers** for test data setup:
   - Read `api/helpers/` to see what CRUD operations are available
   - Use API setup/teardown instead of UI clicks for test data

## Writing a New Spec

Create spec files at `tests/{area}/{feature}.spec.ts`:

```typescript
import { expect, test } from '@fixtures/base-fixture';

test.describe('Feature Name - WA-XXXX', () => {
  test.beforeEach(async ({ pageManager, api }) => {
    // API: create test data if needed
    // Navigate: pageManager.gotoNavigateTo().navigateToPage()
  });

  test.afterEach(async ({ api }) => {
    // API: cleanup test data
  });

  test('acceptance criterion 1', async ({ pageManager }) => {
    await test.step('Step 1: navigate to feature', async () => {
      // Use page objects from pageManager
    });
    await test.step('Step 2: perform action', async () => {
      // Interact with UI
    });
    await test.step('Step 3: verify outcome', async () => {
      // expect(...).toBe(...)
    });
  });
});
```

### Annotations (link back to Jira)

```typescript
test('criterion', async ({ pageManager }, testInfo) => {
  testInfo.annotations.push(
    { type: 'Jira', description: 'WA-XXXX' },
    { type: 'Link', description: 'https://workaxle.atlassian.net/browse/WA-XXXX' }
  );
  // ...
});
```

## Running Tests

```bash
cd /Users/patrick/agents/qa

# Run a specific spec
npx playwright test tests/management/delegation/delegation.spec.ts

# Run with headed browser (for debugging)
npx playwright test tests/path/spec.ts --headed

# Run a specific test by name
npx playwright test -g "delegation to manager succeeds"

# Show HTML report after run
npx playwright show-report
```

Auth setup runs automatically — no manual login needed.

## Adding a New Page Object

If the feature under test doesn't have a page object yet:

1. **Create the page** at `pages/managementPage/{featureName}Page/{featureName}.page.ts`
2. **Extend BasePage** and define locators
3. **Register in pageManager.ts** — add property + accessor method
4. **Use in specs** via `pageManager.featureNamePage`

Follow the pattern of existing page objects — read one first.

## Handling Missing UI Coverage

When automation-test-qa doesn't have page objects for the feature you're testing:

1. **Use Playwright MCP** (`playwright` MCP server) to explore the page and discover selectors
2. **Create the page object** in the repo following existing patterns
3. **Write the spec** using the new page object
4. **Commit both** to the automation-test-qa repo

## Test Results Report

After running, produce:

```markdown
## QA Results — [Feature/Ticket]

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| 1 | ... | PASS/FAIL | ... |

### Command
`npx playwright test tests/path/spec.ts`

### Environment
- URL: https://dev.workaxle.com
- Spec: tests/path/spec.ts
- Date: YYYY-MM-DD
```

## Environment

| Setting    | Value                                                        |
|------------|--------------------------------------------------------------|
| Target     | `https://dev.workaxle.com`                                   |
| User       | `demo@workaxle.com` / `workaxle`                             |
| Auth state | `playwright/.auth/user.json` (auto-created by setup project) |
| Timezone   | `America/Toronto`                                            |
| Viewport   | 1536x864                                                     |
| SlowMo     | 500ms                                                        |
```

**Step 2: Commit**

```bash
cd /Users/patrick/Projects/ruly/rules
git add workaxle/qa/qa-testing.md
git commit -m "feat(qa): add QA testing rule — uses automation-test-qa repo directly"
```

---

## Task 3: Create the `run-acceptance-test` Skill

**Files:**
- Create: `rules/workaxle/skills/run-acceptance-test.md`

**Step 1: Create the skill**

Write to `rules/workaxle/skills/run-acceptance-test.md`:

```markdown
---
name: run-acceptance-test
description: Use when you have acceptance criteria to validate — reads page objects from automation-test-qa, writes a spec, runs it with Playwright
alwaysApply: false
requires:
  - ../qa/qa-testing.md
---

# Run Acceptance Test

## Input

Accepts one of:
- **Direct AC** — user provides criteria in the prompt
- **Jira ticket** — `run-acceptance-test WA-XXXX`
- **PR number** — `run-acceptance-test PR:7495`

## Workflow

### Step 1: Gather Acceptance Criteria

**From Jira:**
```bash
jira issue view WA-XXXX --plain 2>/dev/null | head -100
```

**From PR:**
```bash
gh pr view NNNN --repo workaxle/workaxle --json body --jq .body
```

Extract AC or test plan section.

### Step 2: Find Relevant Page Objects

```bash
# See what page objects exist
ls /Users/patrick/agents/qa/pages/managementPage/
ls /Users/patrick/agents/qa/pages/settingsPage/
```

Read the page objects relevant to the AC. Read `pages/pageManager.ts` to see what's wired up.

If the feature area doesn't have page objects yet, read the UI with Playwright MCP to discover selectors, then create a new page object following existing patterns.

### Step 3: Find Similar Existing Specs

```bash
ls /Users/patrick/agents/qa/tests/management/
ls /Users/patrick/agents/qa/tests/settings/
```

Read a similar spec to match the project's patterns (imports, describe structure, beforeEach/afterEach, test.step usage, annotations).

### Step 4: Write the Spec

Create `tests/{area}/{feature}.spec.ts` following the patterns from [QA Acceptance Testing](#qa-acceptance-testing).

Each acceptance criterion becomes a `test()` block. Each step within becomes a `test.step()`.

### Step 5: Run the Spec

```bash
cd /Users/patrick/agents/qa
npx playwright test tests/{area}/{feature}.spec.ts
```

If tests fail, read the output, fix the spec, and re-run. Use `--headed` for visual debugging if needed.

### Step 6: Report Results

Produce the results table per [QA Acceptance Testing](#qa-acceptance-testing) report format.

### Step 7: Commit the New Spec

```bash
cd /Users/patrick/agents/qa
git add tests/{area}/{feature}.spec.ts
git add pages/  # If new page objects were created
git commit -m "test(WA-XXXX): add acceptance tests for [feature name]"
```

Ask user before pushing.
```

**Step 2: Commit**

```bash
cd /Users/patrick/Projects/ruly/rules
git add workaxle/skills/run-acceptance-test.md
git commit -m "feat(qa): add run-acceptance-test skill"
```

---

## Task 4: Create the `sync-qa-repo` Skill

**Files:**
- Create: `rules/workaxle/skills/sync-qa-repo.md`

**Step 1: Create the skill**

Write to `rules/workaxle/skills/sync-qa-repo.md`:

```markdown
---
name: sync-qa-repo
description: Use when automation-test-qa has new commits — pulls latest, reports what changed (new page objects, specs, helpers)
alwaysApply: false
requires:
  - ../qa/qa-testing.md
---

# Sync QA Repo

## Workflow

### Step 1: Pull Latest

```bash
cd /Users/patrick/agents/qa
git fetch origin main
git log --oneline HEAD..origin/main
```

If no new commits, report "Already up to date" and stop.

```bash
git pull origin main
```

### Step 2: Report What Changed

```bash
cd /Users/patrick/agents/qa
# Show changed files since last pull
git diff HEAD~N --name-only -- pages/ tests/ api/helpers/
```

Group changes by type:
- **New page objects** — new files in `pages/`
- **Updated page objects** — modified files in `pages/`
- **New specs** — new files in `tests/`
- **New API helpers** — new/modified files in `api/helpers/`

### Step 3: Summarize for the User

```markdown
## QA Repo Sync — [date]

**Pulled:** [N] new commits from main

### New Page Objects
- `pages/managementPage/newFeaturePage/` — [description]

### Updated Pages
- `pages/managementPage/schedulePage/` — added new shift selectors

### New Test Specs
- `tests/management/newFeature/spec.ts` — [what it tests]

### New API Helpers
- `api/helpers/newHelper.ts` — [what CRUD it provides]
```

### Step 4: Install New Dependencies (if any)

```bash
cd /Users/patrick/agents/qa
npm install
```
```

**Step 2: Commit**

```bash
cd /Users/patrick/Projects/ruly/rules
git add workaxle/skills/sync-qa-repo.md
git commit -m "feat(qa): add sync-qa-repo skill"
```

---

## Task 5: Add the QA Recipe to recipes.yml

**Files:**
- Modify: `/Users/patrick/Projects/ruly/recipes.yml`
- Modify: `~/.config/ruly/recipes.yml` (sync)
- Modify: `/Users/patrick/Projects/chezmoi/config/ruly/recipes.yml` (sync)

**Step 1: Add the `qa` recipe to `recipes.yml`**

Add after the `playwright` recipe block (line ~434):

```yaml
  qa:
    description: "WorkAxle QA acceptance testing — write and run specs in automation-test-qa against dev.workaxle.com"
    files:
      # === QA Testing Workflow ===
      - /Users/patrick/Projects/ruly/rules/workaxle/qa/qa-testing.md
      # === Playwright Patterns ===
      - /Users/patrick/Projects/ruly/rules/workaxle/orchestrator/playwright.md
      # === Skills ===
      - /Users/patrick/Projects/ruly/rules/workaxle/skills/run-acceptance-test.md
      - /Users/patrick/Projects/ruly/rules/workaxle/skills/sync-qa-repo.md
      # === Jira (for fetching AC from tickets) ===
      - /Users/patrick/Projects/ruly/rules/comms/jira/
    mcp_servers:
      - playwright # For exploring UI when page objects are missing
```

**Step 2: Sync to both config locations**

Copy the exact `qa:` block to:
- `~/.config/ruly/recipes.yml`
- `/Users/patrick/Projects/chezmoi/config/ruly/recipes.yml`

**Step 3: Commit**

```bash
cd /Users/patrick/Projects/ruly
git add recipes.yml
git commit -m "feat(qa): add qa recipe to recipes.yml"
```

---

## Task 6: Test the Full Flow with PR 7495

**Files:** None (validation only)

**Step 1: Verify recipe squashes**

```bash
cd $(mktemp -d) && ruly squash --recipe qa
```

**Step 2: Verify automation-test-qa runs**

```bash
cd /Users/patrick/agents/qa
npx playwright test --project=setup
```

Auth should pass and create `playwright/.auth/user.json`.

**Step 3: Test the workflow manually**

In a new Claude Code session with the QA recipe loaded:

```
/run-acceptance-test PR:7495
```

Expect:
1. AC extracted from PR 7495 body
2. Agent reads relevant page objects from automation-test-qa
3. Agent creates `tests/management/delegation/delegation.spec.ts`
4. Agent runs `npx playwright test tests/management/delegation/delegation.spec.ts`
5. Results reported

**Step 4: Fix any issues and iterate**

If the delegation feature doesn't have page objects yet, the agent should:
1. Use Playwright MCP to explore the delegation UI on dev.workaxle.com
2. Create `pages/managementPage/delegationPage/delegation.page.ts`
3. Register it in `pageManager.ts`
4. Write the spec using the new page object

---

## Task 7: Wire QA Dispatch into Core Recipe (Optional)

**Files:**
- Create: `rules/workaxle/core/standards/use-qa.md`
- Modify: `recipes.yml` — add to `core` recipe

Only if you want `core` orchestrator to auto-dispatch to QA when user asks to test AC.

**Step 1: Create dispatch rule**

Write to `rules/workaxle/core/standards/use-qa.md`:

```markdown
---
description: Dispatch to QA subagent for acceptance testing
alwaysApply: true
---

# QA Dispatch

When the user asks to test acceptance criteria, run QA tests, validate a feature on dev, or check if AC passes — dispatch to the `qa_tester` subagent with the acceptance criteria or ticket reference.
```

**Step 2: Add to core recipe**

In `recipes.yml`, add to the `core` recipe:

Files list:
```yaml
- /Users/patrick/Projects/ruly/rules/workaxle/core/standards/use-qa.md
```

Subagents list:
```yaml
- name: qa_tester
  recipe: qa
```

**Step 3: Sync + commit**

```bash
cd /Users/patrick/Projects/ruly/rules
git add workaxle/core/standards/use-qa.md
cd /Users/patrick/Projects/ruly
git add recipes.yml
git commit -m "feat(qa): wire QA dispatch into core orchestrator"
```

---

## Task 8: Update README.md

**Files:**
- Modify: `/Users/patrick/Projects/ruly/README.md`

**Step 1: Add QA recipe to recipes section**

**Step 2: Add slash command docs for `/run-acceptance-test` and `/sync-qa-repo`**

**Step 3: Commit**

```bash
cd /Users/patrick/Projects/ruly
git add README.md
git commit -m "docs: add QA recipe and skills to README"
```

---

## Summary

| Task | What                                     | Files                                                     |
|------|------------------------------------------|-----------------------------------------------------------|
| 1    | Clone + install automation-test-qa       | Local setup                                               |
| 2    | QA testing rule (repo layout + workflow) | `rules/workaxle/qa/qa-testing.md`                         |
| 3    | Run acceptance test skill                | `rules/workaxle/skills/run-acceptance-test.md`            |
| 4    | Sync QA repo skill                       | `rules/workaxle/skills/sync-qa-repo.md`                   |
| 5    | Recipe in recipes.yml                    | `recipes.yml` + synced copies                             |
| 6    | Test with PR 7495                        | Validation                                                |
| 7    | Wire into core (optional)                | `rules/workaxle/core/standards/use-qa.md` + `recipes.yml` |
| 8    | Update README                            | `README.md`                                               |

**Key difference from v1:** No page registry duplication. The agent reads `.ts` source files directly from the automation-test-qa clone, writes specs in that repo using its existing infrastructure, and runs them with `npx playwright test`. The rule file is a lightweight repo map + workflow guide, not a selector dump.
