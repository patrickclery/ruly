# Product Requirements Document: Agent Generation from Recipes

## Overview
Extend Ruly's existing `squash` command to automatically detect array-type recipes and generate them as Claude Code agent files instead of standard output files. When a recipe value is an array of recipe references, it will be output to `.claude/agents/{recipe_name}.md` instead of the default output location.

## Problem Statement
Currently, Ruly supports generating `CLAUDE.local.md` files from recipes, but lacks the ability to:
1. Generate Claude Code agent files (`.claude/agents/*.md`)
2. Combine multiple recipes into a single configuration
3. Automatically organize agents based on recipe structure

## Goals
1. Extend `ruly squash` to detect array-type recipes and auto-generate agent files
2. Support array-based multi-recipe definitions for combining recipes
3. Maintain 100% backward compatibility with existing hash-type recipe definitions
4. Use the existing `recipes.recipe_name` structure (no new top-level keys)
5. Maintain YAML anchor/alias pattern for DRY recipe definitions
6. Generate proper agent metadata and formatting

## Non-Goals
- Adding new commands (use existing `squash` command)
- Breaking changes to existing recipe format
- Creating new recipe file formats or top-level keys
- Agent runtime or execution logic
- Changing how existing hash-type recipes work

## User Stories

### Story 1: Existing Single-Recipe Behavior (Unchanged)
**As a** developer using Ruly
**I want to** use recipes with `squash` command as before
**So that** backward compatibility is maintained

```yaml
recipes:
  workaxle_core:
    description: "Core WorkAxle patterns"
    files:
      - rules/workaxle/core/frameworks/common.md
```

```bash
ruly squash --recipe workaxle_core  # Works exactly as before
```

### Story 2: Array-Based Multi-Recipe Agent (Auto-Detected)
**As a** developer managing complex projects
**I want to** define a recipe as an array of other recipes
**So that** `ruly squash` automatically outputs it to `.claude/agents/` instead

```yaml
recipes:
  workaxle_core: &workaxle_core
    description: "Core patterns"
    files: [...]

  rails_patterns: &rails_patterns
    description: "Rails practices"
    files: [...]

  # Array value = auto-generates as agent
  workaxle_full:
    - *workaxle_core
    - *rails_patterns
```

```bash
ruly squash --recipe workaxle_full
```

**Automatically creates:** `.claude/agents/workaxle_full.md` (not `CLAUDE.local.md`)

### Story 3: Output Override Still Works
**As a** developer
**I want to** override the output location even for array-type recipes
**So that** I have full control when needed

```bash
ruly squash --recipe workaxle_full --output-file custom.md
```

Creates: `custom.md` (overrides auto-detection)

## Technical Specification

### Recipe Type Detection Logic

The system determines recipe type by checking if the value is an array:

```ruby
def recipe_type(recipe_value)
  if recipe_value.is_a?(Array)
    :agent  # Array = agent file
  elsif recipe_value.is_a?(Hash)
    :standard  # Hash = traditional recipe
  else
    :invalid
  end
end
```

### Recipe Schema Pattern

```yaml
recipes:
  # Standard recipes (Hash) - work with squash/import
  workaxle_core: &workaxle_core
    description: "Core WorkAxle patterns"
    files:
      - rules/workaxle/core/frameworks/common.md
      - rules/workaxle/core/frameworks/sequel.md
      - rules/workaxle/core/frameworks/monads.md
      - rules/workaxle/core/frameworks/rspec.md

  rails_patterns: &rails_patterns
    description: "Rails best practices"
    files:
      - rules/ruby/ruby-practices.md
      - rules/ruby/sequel.md

  testing_suite: &testing_suite
    description: "Testing patterns"
    files:
      - rules/ruby/rspec.md

  # Agent recipes (Array) - automatically generate to .claude/agents/
  workaxle_full:
    - *workaxle_core
    - *rails_patterns
    - *testing_suite

  workaxle_backend:
    - *workaxle_core
    - *rails_patterns

  # Single-reference agent also supported
  workaxle_core_agent:
    - *workaxle_core
```

### Key Differences

| Feature | Standard Recipe (Hash) | Agent Recipe (Array) |
|---------|----------------------|----------------------|
| Structure | `recipe_name: {description, files, sources}` | `recipe_name: [*ref1, *ref2]` |
| Output Command | `ruly squash --recipe name` | `ruly agent name` |
| Output Location | `CLAUDE.local.md` (or custom) | `.claude/agents/name.md` |
| Use Case | General rules compilation | Specialized agent creation |
| Multiple Recipes | No | Yes |

### Agent File Format

Generated agent files should follow Claude Code agent format:

```markdown
---
description: [Recipe description]
---

# [Agent Name]

[Combined content from all recipe files]

## Source Files

<!-- Generated from recipes: recipe1, recipe2 -->
<!-- Files included:
  - path/to/file1.md
  - path/to/file2.md
-->
```

### Enhanced `ruly squash` Behavior

The existing `squash` command will be enhanced to auto-detect array-type recipes:

```
ruly squash [RECIPE] [OPTIONS]

Existing behavior (unchanged):
  - Hash-type recipes output to --output-file (default: CLAUDE.local.md)
  - All existing options work the same

New behavior (automatic):
  - Array-type recipes auto-output to .claude/agents/{recipe_name}.md
  - Unless --output-file is explicitly provided (which overrides)
```

#### Decision Logic in `squash` Command

```ruby
def determine_output_file(recipe_name, recipe_value, options)
  # User explicitly specified output file - use it
  return options[:output_file] if options[:output_file] != default_output_file

  # Auto-detect based on recipe type
  if recipe_value.is_a?(Array)
    # Array recipe = agent file
    ".claude/agents/#{recipe_name}.md"
  else
    # Hash recipe = default behavior
    'CLAUDE.local.md'
  end
end
```

#### Examples

```bash
# Hash recipe (existing behavior)
ruly squash --recipe workaxle_core
# Output: CLAUDE.local.md

# Array recipe (new auto-detection)
ruly squash --recipe workaxle_full
# Output: .claude/agents/workaxle_full.md

# Array recipe with override
ruly squash --recipe workaxle_full --output-file custom.md
# Output: custom.md

# All other flags work the same
ruly squash --recipe workaxle_full --dry-run --toc
# Previews what would be written to .claude/agents/workaxle_full.md
```

### Implementation Requirements

#### Phase 1: Detection and Output Routing
1. Modify `squash` command to detect array vs hash recipe types
2. Implement `determine_output_file` logic
3. Auto-create `.claude/agents/` directory when needed
4. Ensure `--output-file` override still works
5. Update user-facing messages to indicate agent file creation

#### Phase 2: Array Recipe Processing
1. Modify `load_recipe_sources` to handle array-type recipes
2. Parse array elements (recipe references from anchors)
3. Recursively collect all files from referenced recipes
4. Deduplicate files by path (first occurrence wins)
5. Preserve proper ordering

#### Phase 3: Validation and Error Handling
1. Validate array elements resolve to hash recipes
2. Handle missing or invalid recipe references
3. Warn on empty recipes
4. Comprehensive error messages

#### Phase 4: Metadata and Documentation
1. Generate appropriate agent frontmatter
2. Add comment indicating source recipes
3. Support existing --toc, --essential, --cache flags
4. Update CLI help text and documentation

### Recipe Resolution Logic

```ruby
def resolve_agent_recipe(recipe_name, recipe_value)
  # Validate that recipe_value is an array
  unless recipe_value.is_a?(Array)
    raise "Recipe '#{recipe_name}' must be an array to generate an agent"
  end

  sources = []
  referenced_recipes = []

  # Iterate through each recipe reference in the array
  recipe_value.each do |recipe_ref|
    # recipe_ref should be a hash (dereferenced anchor)
    unless recipe_ref.is_a?(Hash)
      raise "Invalid recipe reference in '#{recipe_name}'"
    end

    referenced_recipes << extract_recipe_name(recipe_ref)

    # Process files from this recipe
    if recipe_ref['files']
      sources.concat(process_files(recipe_ref['files']))
    end

    # Process sources from this recipe
    if recipe_ref['sources']
      sources.concat(process_sources(recipe_ref['sources']))
    end

    # Handle legacy remote_sources
    if recipe_ref['remote_sources']
      sources.concat(process_remote_sources(recipe_ref['remote_sources']))
    end
  end

  # Deduplicate by path (first occurrence wins)
  {
    sources: sources.uniq { |s| s[:path] },
    referenced_recipes: referenced_recipes
  }
end

def is_agent_recipe?(recipe_value)
  recipe_value.is_a?(Array)
end

def get_agent_recipes
  all_recipes = load_all_recipes
  all_recipes.select { |name, value| is_agent_recipe?(value) }
end
```

### File Organization

```
.claude/
└── agents/
    ├── workaxle-core.md
    ├── workaxle-full.md
    ├── testing-suite.md
    └── README.md (auto-generated index)
```

## Edge Cases & Error Handling

1. **Non-Array Recipe**: Error if trying to use `ruly agent` on hash-type recipe
2. **Missing Recipe Reference**: Clear error when array contains reference to non-existent recipe
3. **Empty Array**: Error if array-type recipe has no elements
4. **Empty Referenced Recipes**: Warn if referenced recipe has no files/sources
5. **File Not Found**: Skip missing files with warning, continue processing
6. **Invalid YAML Structure**: Detect and report YAML parsing errors
7. **Duplicate Agents**: Require `--force` flag to overwrite existing agent files
8. **Remote Source Failures**: Graceful degradation with caching support
9. **Circular References**: Not applicable (array can't reference itself in YAML)
10. **Mixed Types in Array**: Validate all array elements resolve to hash recipes

## Validation Rules

1. Recipe must exist in `recipes.yml`
2. Array-type recipes must contain at least one element
3. Array elements must resolve to valid hash-type recipes
4. At least one source file must be resolved from combined recipes
5. Output directory must be writable (auto-create `.claude/agents/` if needed)
6. Recipe name must be valid filename (alphanumeric, hyphens, underscores)

## Success Metrics

1. Existing hash-type recipes work exactly as before (100% backward compatible)
2. Array-type recipes automatically output to `.claude/agents/` directory
3. Users can combine multiple recipes using YAML anchors
4. Generated agent files work correctly in Claude Code
5. Command completes in <5 seconds for typical recipes
6. Clear error messages for all failure cases
7. `--output-file` override works for both recipe types

## Future Enhancements

1. Add `--list-agents` flag to show all array-type recipes
2. Add `--all-agents` flag to generate all array-type recipes at once
3. Auto-generate an index/README for the agents directory
4. Agent validation against Claude Code schema
5. Support for agent-specific metadata in frontmatter
6. Integration with TaskMaster for agent-specific tasks

## Open Questions

1. Should we extract descriptions from referenced recipes for agent metadata?
2. Should we support nested arrays (arrays of arrays)?
3. How should we handle duplicate file paths across recipes (first wins)?
4. Should there be a flag to explicitly disable agent auto-detection?
5. Should we warn if someone uses `--recipe` with an array but also specifies `--output-file`?

## Appendix

### Example recipes.yml Structure

```yaml
plan: claude_pro

recipes:
  # Standard hash recipes (work with squash as before)
  workaxle_core: &workaxle_core
    description: "Core WorkAxle patterns"
    files:
      - rules/workaxle/core/frameworks/common.md
      - rules/workaxle/core/frameworks/monads.md
      - rules/workaxle/core/frameworks/rspec.md
      - rules/workaxle/core/frameworks/sequel.md

  rails_best_practices: &rails_best_practices
    description: "Rails development patterns"
    files:
      - rules/ruby/ruby-practices.md
      - rules/ruby/sequel.md

  testing_suite: &testing_suite
    description: "Testing frameworks and patterns"
    files:
      - rules/ruby/rspec.md
      - rules/testing/factories.md

  # Array recipes (auto-output to .claude/agents/)
  workaxle_full:
    - *workaxle_core
    - *rails_best_practices
    - *testing_suite

  workaxle_backend:
    - *workaxle_core
    - *rails_best_practices

  # Single-reference array (also creates agent)
  workaxle_core_agent:
    - *workaxle_core
```

### Usage Examples

```bash
# Hash recipe - outputs to CLAUDE.local.md
ruly squash --recipe workaxle_core

# Array recipe - auto-outputs to .claude/agents/workaxle_full.md
ruly squash --recipe workaxle_full

# Array recipe with override - outputs to custom location
ruly squash --recipe workaxle_full --output-file my-agent.md
```

### Example Generated Agent

```markdown
---
description: Complete WorkAxle development stack with testing
---

# WorkAxle Full Stack Agent

This agent combines core WorkAxle patterns, Rails best practices, and testing frameworks.

---

## /rules/workaxle/core/frameworks/common.md

[Content of common.md]

---

## /rules/workaxle/core/frameworks/monads.md

[Content of monads.md]

---

<!-- Generated by Ruly v1.x.x -->
<!-- Source recipes: workaxle_core, rails_best_practices, testing_suite -->
<!-- Total files: 8 -->
```
